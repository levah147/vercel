{% extends "main_app/base.html" %}
{% load static %}

{% comment %} {% block page_title %}{{ page_title }}{% endblock %} {% endcomment %}

{% block custom_css %}
<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #4776E6 0%, #8E54E9 100%);
        --secondary-gradient: linear-gradient(135deg, #FF9966 0%, #FF5E62 100%);
        --success-gradient: linear-gradient(135deg, #2DCE89 0%, #2DCCA7 100%);
        --danger-gradient: linear-gradient(135deg, #FF5E62 0%, #FF2950 100%);
        --card-border-radius: 0.75rem;
        --transition-speed: 0.3s;
    }

    .page-header {
        background: var(--primary-gradient);
        border-radius: var(--card-border-radius);
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 10px 20px rgba(71, 118, 230, 0.1);
    }

    .page-header h2 {
        color: white;
        margin: 0;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .selection-card {
        border: none;
        border-radius: var(--card-border-radius);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        transition: all var(--transition-speed);
        overflow: hidden;
    }

    .selection-card:hover {
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .selection-card .card-header {
        background: white;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        padding: 1.25rem 1.5rem;
    }

    .selection-card .card-header h5 {
        font-weight: 600;
        color: #333;
        margin: 0;
    }

    .attendance-card {
        border: none;
        border-radius: var(--card-border-radius);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        transition: all var(--transition-speed);
    }

    .attendance-card:hover {
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    .attendance-card .card-header {
        background: var(--primary-gradient);
        padding: 1.25rem 1.5rem;
        border: none;
    }

    .attendance-card .card-header h5 {
        font-weight: 600;
        letter-spacing: 0.5px;
        margin: 0;
    }

    .attendance-card .term-badge {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border-radius: 50px;
        padding: 0.5rem 1rem;
        font-weight: 500;
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .form-control, .form-select {
        border-radius: 0.5rem;
        padding: 0.75rem 1rem;
        border: 1px solid rgba(0, 0, 0, 0.1);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02);
        transition: all var(--transition-speed);
    }

    .form-control:focus, .form-select:focus {
        border-color: #4776E6;
        box-shadow: 0 0 0 0.25rem rgba(71, 118, 230, 0.25);
    }

    .form-label {
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: #555;
    }

    .btn {
        border-radius: 0.5rem;
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        transition: all var(--transition-speed);
    }

    .btn-primary {
        background: var(--primary-gradient);
        border: none;
        box-shadow: 0 4px 10px rgba(71, 118, 230, 0.3);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(71, 118, 230, 0.4);
    }

    .btn-outline-secondary {
        border: 1px solid rgba(0, 0, 0, 0.2);
        color: #555;
    }

    .btn-outline-secondary:hover {
        background: #f8f9fa;
        color: #333;
    }

    .table {
        margin-bottom: 0;
    }

    .table thead th {
        background: #f8f9fa;
        color: #333;
        font-weight: 600;
        border-top: none;
        padding: 1rem;
        white-space: nowrap;
    }

    .table tbody td {
        padding: 1rem;
        vertical-align: middle;
        border-color: rgba(0, 0, 0, 0.05);
    }

    .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(0, 0, 0, 0.01);
    }

    .table-hover tbody tr:hover {
        background-color: rgba(71, 118, 230, 0.05);
    }

    .student-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid white;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .avatar-placeholder {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #e9ecef;
        color: #6c757d;
        font-size: 1.2rem;
        border: 2px solid white;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .student-name {
        font-weight: 500;
        color: #333;
    }

    .student-email {
        color: #6c757d;
        font-size: 0.9rem;
    }

    .program-badge {
        background: #f8f9fa;
        color: #555;
        border-radius: 50px;
        padding: 0.35rem 0.75rem;
        font-size: 0.85rem;
        font-weight: 500;
        white-space: nowrap;
        display: inline-block;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .attendance-checkbox {
        width: 1.25rem;
        height: 1.25rem;
        cursor: pointer;
    }

    .present-checkbox:checked {
        background-color: #2DCE89;
        border-color: #2DCE89;
    }

    .absent-checkbox:checked {
        background-color: #FF5E62;
        border-color: #FF5E62;
    }

    .attendance-count {
        font-size: 0.85rem;
        padding: 0.35rem 0.6rem;
        border-radius: 50px;
        margin-left: 0.5rem;
        font-weight: 500;
        min-width: 28px;
        display: inline-block;
    }

    .present-count {
        background: linear-gradient(135deg, #2DCE89 0%, #2DCCA7 100%);
    }

    .absent-count {
        background: linear-gradient(135deg, #FF5E62 0%, #FF2950 100%);
    }

    .attendance-status {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .card-footer {
        background: white;
        border-top: 1px solid rgba(0, 0, 0, 0.05);
        padding: 1rem 1.5rem;
    }

    .auto-save-indicator {
        display: flex;
        align-items: center;
        color: #6c757d;
        font-size: 0.9rem;
    }

    .auto-save-indicator .indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #2DCE89;
        margin-right: 0.5rem;
    }

    .toast {
        background: white;
        border: none;
        border-radius: var(--card-border-radius);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .toast-header {
        background: var(--primary-gradient);
        color: white;
        border: none;
    }

    .toast-header .btn-close {
        filter: brightness(0) invert(1);
        opacity: 0.8;
    }

    .toast-body {
        padding: 1rem;
        font-weight: 500;
    }

    .alert {
        border-radius: var(--card-border-radius);
        padding: 1.25rem;
        border: none;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    }

    .alert-warning {
        background: linear-gradient(135deg, #FFD166 0%, #F8B500 100%);
        color: #664d03;
    }

    .alert-info {
        background: linear-gradient(135deg, #56CCF2 0%, #2F80ED 100%);
        color: white;
    }

    /* Animation for status changes */
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    .attendance-updated {
        animation: pulse 0.5s ease-in-out;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .page-header {
            padding: 1.5rem;
        }
        
        .btn {
            padding: 0.6rem 1.2rem;
        }
        
        .table thead th, 
        .table tbody td {
            padding: 0.75rem;
        }
        
        .student-avatar,
        .avatar-placeholder {
            width: 32px;
            height: 32px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-2 mb-5">
    <!-- Page Header -->
    <div class="page-header text-center">
        <h2><i class="fas fa-clipboard-check me-2"></i>Student Attendance</h2>
    </div>

    <div class="row">
        <div class="col-12">
            <!-- Session and Term Selection Card -->
            <div class="card selection-card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-filter me-2"></i>Filter Options</h5>
                </div>
                <div class="card-body p-4">
                    <form method="GET" id="selectionForm">
                        <div class="row g-3">
                            <div class="col-md-5">
                                <div class="form-group">
                                    <label for="session" class="form-label">Academic Session</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-white">
                                            <i class="fas fa-calendar-alt text-primary"></i>
                                        </span>
                                        <select name="session" id="session" class="form-select" aria-label="Select Session">
                                            <option value="">-- Select Session --</option>
                                            {% for session in sessions %}
                                                <option value="{{ session.id }}" {% if session.id|stringformat:"s" == selected_session_id %}selected{% endif %}>
                                                    {{ session.start_year }} - {{ session.end_year }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-5">
                                <div class="form-group">
                                    <label for="term" class="form-label">Term</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-white">
                                            <i class="fas fa-book text-primary"></i>
                                        </span>
                                        <select name="term" id="term" class="form-select" aria-label="Select Term" {% if not selected_session_id %}disabled{% endif %}>
                                            <option value="">-- Select Term --</option>
                                            {% if selected_session_id %}
                                                {% for term in terms %}
                                                    {% if term.session.id|stringformat:"s" == selected_session_id %}
                                                        <option value="{{ term.id }}" {% if term.id|stringformat:"s" == selected_term_id %}selected{% endif %}>
                                                            {{ term.name }} Term
                                                        </option>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-search me-2"></i> Load
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Attendance Table -->
            {% if selected_session_id and selected_term_id %}
                <div class="card attendance-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="text-white mb-0"><i class="fas fa-user-check me-2"></i>Attendance Record</h5>
                        <span class="term-badge">
                            <i class="fas fa-calendar-alt me-1"></i> 
                            {{ selected_term_name|default:"Current Term" }}
                        </span>
                    </div>
                    <div class="card-body p-0">
                        <form method="POST" id="attendanceForm" action="{% url 'mark_attendance' %}">
                            {% csrf_token %}
                            <input type="hidden" id="sessionIdInput" name="session_id" value="{{ selected_session_id }}">
                            <input type="hidden" id="termIdInput" name="term_id" value="{{ selected_term_id }}">
                        
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th scope="col" width="5%" class="text-center">#</th>
                                            <th scope="col" width="30%">Student</th>
                                            <th scope="col" width="25%">Contact</th>
                                            <th scope="col" width="20%">Program</th>
                                            <th scope="col" width="10%" class="text-center">Present</th>
                                            <th scope="col" width="10%" class="text-center">Absent</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for student in students %}
                                        <tr id="student-row-{{ student.id }}">
                                            <td class="text-center">{{ forloop.counter }}</td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    {% if student.admin.profile_pic %}
                                                        <img src="{{ student.admin.profile_pic.url }}" alt="" class="student-avatar me-3">
                                                    {% else %}
                                                        <div class="avatar-placeholder me-3">
                                                            <i class="fas fa-user"></i>
                                                        </div>
                                                    {% endif %}
                                                    <div>
                                                        <div class="student-name">{{ student.admin.first_name }} {{ student.admin.last_name }}</div>
                                                        <div class="student-id">ID: {{ student.id_number|default:"N/A" }}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="student-email">
                                                    <i class="fas fa-envelope me-1 text-muted"></i> {{ student.admin.email }}
                                                </div>
                                                {% if student.phone_number %}
                                                <div class="student-phone mt-1">
                                                    <i class="fas fa-phone me-1 text-muted"></i> {{ student.phone_number }}
                                                </div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <span class="program-badge">
                                                    <i class="fas fa-graduation-cap me-1"></i> {{ student.program.name }}
                                                </span>
                                            </td>
                                            <td class="text-center attendance-status">
                                                <div class="form-check">
                                                    <input type="checkbox" 
                                                        class="form-check-input attendance-checkbox present-checkbox" 
                                                        id="present-{{ student.id }}"
                                                        data-student-id="{{ student.id }}"
                                                        data-session-id="{{ selected_session_id }}"
                                                        data-term-id="{{ selected_term_id }}"
                                                        data-status="present"
                                                        aria-label="Mark as present"
                                                        {% if student.attendance_record and student.attendance_record.is_present %}checked{% endif %}>
                                                    <label class="form-check-label visually-hidden" for="present-{{ student.id }}">Present</label>
                                                </div>
                                                <span class="badge attendance-count present-count" id="present-count-{{ student.id }}">
                                                    {% if student.attendance_record and student.attendance_record.is_present %}1{% else %}0{% endif %}
                                                </span>
                                            </td>
                                            <td class="text-center attendance-status">
                                                <div class="form-check">
                                                    <input type="checkbox" 
                                                        class="form-check-input attendance-checkbox absent-checkbox" 
                                                        id="absent-{{ student.id }}"
                                                        data-student-id="{{ student.id }}"
                                                        data-session-id="{{ selected_session_id }}"
                                                        data-term-id="{{ selected_term_id }}"
                                                        data-status="absent"
                                                        aria-label="Mark as absent"
                                                        {% if student.attendance_record and student.attendance_record.is_absent %}checked{% endif %}>
                                                    <label class="form-check-label visually-hidden" for="absent-{{ student.id }}">Absent</label>
                                                </div>
                                                <span class="badge attendance-count absent-count" id="absent-count-{{ student.id }}">
                                                    {% if student.attendance_record and student.attendance_record.is_absent %}1{% else %}0{% endif %}
                                                </span>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="6" class="text-center py-5">
                                                <div class="empty-state">
                                                    <i class="fas fa-users text-muted" style="font-size: 3rem;"></i>
                                                    <h5 class="mt-3">No Students Found</h5>
                                                    <p class="text-muted">No students are enrolled for the selected session and term.</p>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </form>
                    </div>
                    <div class="card-footer d-flex justify-content-between align-items-center">
                        <div class="auto-save-indicator">
                            <span class="indicator"></span>
                            <span>Changes are saved automatically</span>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" id="exportBtn" class="btn btn-outline-secondary">
                                <i class="fas fa-file-export me-1"></i> Export
                            </button>
                            <button type="button" id="refreshBtn" class="btn btn-primary">
                                <i class="fas fa-sync-alt me-1"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Summary Stats Card -->
                <div class="row mt-4">
                    <div class="col-md-4">
                        <div class="card selection-card h-100">
                            <div class="card-body p-4 text-center">
                                <div class="d-inline-flex align-items-center justify-content-center bg-primary bg-opacity-10 p-3 rounded-circle mb-3">
                                    <i class="fas fa-users fa-2x text-primary"></i>
                                </div>
                                <h5 class="mb-1">Total Students</h5>
                                <h2 class="mb-0">{{ students|length }}</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card selection-card h-100">
                            <div class="card-body p-4 text-center">
                                <div class="d-inline-flex align-items-center justify-content-center bg-success bg-opacity-10 p-3 rounded-circle mb-3">
                                    <i class="fas fa-user-check fa-2x text-success"></i>
                                </div>
                                <h5 class="mb-1">Present Today</h5>
                                <h2 class="mb-0" id="present-count-total">{{ present_count|default:"0" }}</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card selection-card h-100">
                            <div class="card-body p-4 text-center">
                                <div class="d-inline-flex align-items-center justify-content-center bg-danger bg-opacity-10 p-3 rounded-circle mb-3">
                                    <i class="fas fa-user-times fa-2x text-danger"></i>
                                </div>
                                <h5 class="mb-1">Absent Today</h5>
                                <h2 class="mb-0" id="absent-count-total">{{ absent_count|default:"0" }}</h2>
                            </div>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="alert alert-warning">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                        <div>
                            <h5 class="mb-1">No Data Selected</h5>
                            <p class="mb-0">Please select both a session and term to view and mark attendance.</p>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="attendanceToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="fas fa-bell me-2"></i>
            <strong class="me-auto">Attendance Update</strong>
            <small class="text-white" id="toastTime">Just now</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            Attendance updated successfully.
        </div>
    </div>
</div>
{% endblock content %}

{% block custom_js %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Session change handler - enable/disable term dropdown
        const sessionSelect = document.getElementById('session');
        const termSelect = document.getElementById('term');
        
        if (sessionSelect) {
            sessionSelect.addEventListener('change', function() {
                if (this.value) {
                    termSelect.disabled = false;
                    termSelect.focus();
                } else {
                    termSelect.disabled = true;
                    termSelect.value = '';
                }
            });
        }
        
        // Refresh button handler
        const refreshBtn = document.getElementById('refreshBtn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', function() {
                // Add loading state
                this.disabled = true;
                this.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Refreshing...';
                
                // Reload the page after a short delay
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            });
        }
        
        // Export button handler
        const exportBtn = document.getElementById('exportBtn');
        if (exportBtn) {
            exportBtn.addEventListener('click', function() {
                alert('Export functionality will be implemented here.');
                // This would typically trigger a download of attendance data in CSV/Excel format
            });
        }
        
        // Initialize toast
        let toastEl = document.getElementById('attendanceToast');
        let toast = new bootstrap.Toast(toastEl, {
            delay: 3000
        });
        
        // Update total counts
        function updateTotalCounts() {
            const presentTotal = document.querySelectorAll('.present-checkbox:checked').length;
            const absentTotal = document.querySelectorAll('.absent-checkbox:checked').length;
            
            const presentTotalEl = document.getElementById('present-count-total');
            const absentTotalEl = document.getElementById('absent-count-total');
            
            if (presentTotalEl) presentTotalEl.textContent = presentTotal;
            if (absentTotalEl) absentTotalEl.textContent = absentTotal;
        }
        
        // Initialize total counts
        updateTotalCounts();
        
        // Attendance checkbox handlers
        document.querySelectorAll(".attendance-checkbox").forEach(checkbox => {
            checkbox.addEventListener("change", function () {
                let studentId = this.dataset.studentId;
                let sessionId = this.dataset.sessionId;
                let termId = this.dataset.termId;
                let status = this.dataset.status;
                let isChecked = this.checked;
                
                // Show loading state
                this.disabled = true;
                
                // Highlight the row being updated
                const studentRow = document.getElementById(`student-row-${studentId}`);
                if (studentRow) {
                    studentRow.style.backgroundColor = 'rgba(71, 118, 230, 0.05)';
                }
                
                // Prevent both checkboxes from being checked at the same time
                if (status === "present" && isChecked) {
                    const absentCheckbox = document.querySelector(`.absent-checkbox[data-student-id="${studentId}"]`);
                    if (absentCheckbox) {
                        absentCheckbox.checked = false;
                        absentCheckbox.disabled = true;
                    }
                } else if (status === "absent" && isChecked) {
                    const presentCheckbox = document.querySelector(`.present-checkbox[data-student-id="${studentId}"]`);
                    if (presentCheckbox) {
                        presentCheckbox.checked = false;
                        presentCheckbox.disabled = true;
                    }
                }
                
                // Update toast time
                document.getElementById('toastTime').textContent = new Date().toLocaleTimeString();
    
                fetch("{% url 'mark_attendance' %}", {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: new URLSearchParams({
                        student_id: studentId,
                        session_id: sessionId,
                        term_id: termId,
                        status: status
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Update the present/absent count
                        const presentCount = document.getElementById(`present-count-${studentId}`);
                        const absentCount = document.getElementById(`absent-count-${studentId}`);
                        
                        if (presentCount) {
                            presentCount.innerText = data.present_count;
                            presentCount.classList.add('attendance-updated');
                            setTimeout(() => presentCount.classList.remove('attendance-updated'), 500);
                        }
                        
                        if (absentCount) {
                            absentCount.innerText = data.absent_count;
                            absentCount.classList.add('attendance-updated');
                            setTimeout(() => absentCount.classList.remove('attendance-updated'), 500);
                        }
                        
                        // Update total counts
                        updateTotalCounts();
                        
                        // Show success toast
                        document.getElementById('toastMessage').innerHTML = `
                            <div class="d-flex align-items-center">
                                <i class="fas fa-check-circle text-success me-2" style="font-size: 1.25rem;"></i>
                                <div>
                                    <strong>${data.student_name || 'Student'}'s attendance</strong> marked as <strong>${status}</strong>
                                </div>
                            </div>
                        `;
                        toast.show();
                    } else {
                        throw new Error(data.message || 'Failed to update attendance');
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    
                    // Show error toast
                    document.getElementById('toastMessage').innerHTML = `
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-circle text-danger me-2" style="font-size: 1.25rem;"></i>
                            <div>
                                <strong>Error:</strong> ${error.message || 'Failed to update attendance. Please try again.'}
                            </div>
                        </div>
                    `;
                    toast.show();
                    
                    // Revert checkbox state on error
                    this.checked = !isChecked;
                })
                .finally(() => {
                    // Re-enable checkboxes
                    document.querySelectorAll(`.attendance-checkbox[data-student-id="${studentId}"]`).forEach(cb => {
                        cb.disabled = false;
                    });
                    
                    // Reset row background
                    if (studentRow) {
                        setTimeout(() => {
                            studentRow.style.backgroundColor = '';
                        }, 500);
                    }
                });
            });
        });
        
        // Add pulse animation to the auto-save indicator
        setInterval(() => {
            const indicator = document.querySelector('.auto-save-indicator .indicator');
            if (indicator) {
                indicator.style.opacity = '0.5';
                setTimeout(() => {
                    indicator.style.opacity = '1';
                }, 500);
            }
        }, 3000);
    });
</script>
{% endblock custom_js %}




{% comment %} {% extends "main_app/base.html" %}
{% load static %}

{% block page_title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container mt-2">
    <div class="row">
        <div class="col-12">
            
            <!-- Session and Term Selection Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Select Session and Term</h5>
                </div>
                <div class="card-body">
                    <form method="GET" id="selectionForm">
                        <div class="row">
                            <div class="col-md-5">
                                <div class="form-group">
                                    <label for="session" class="form-label">Academic Session:</label>
                                    <select name="session" id="session" class="form-control form-select" aria-label="Select Session">
                                        <option value="">-- Select Session --</option>
                                        {% for session in sessions %}
                                            <option value="{{ session.id }}" {% if session.id|stringformat:"s" == selected_session_id %}selected{% endif %}>
                                                {{ session.start_year }} - {{ session.end_year }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-5">
                                <div class="form-group">
                                    <label for="term" class="form-label">Term:</label>
                                    <select name="term" id="term" class="form-control form-select" aria-label="Select Term" {% if not selected_session_id %}disabled{% endif %}>
                                        <option value="">-- Select Term --</option>
                                        {% if selected_session_id %}
                                            {% for term in terms %}
                                                {% if term.session.id|stringformat:"s" == selected_session_id %}
                                                    <option value="{{ term.id }}" {% if term.id|stringformat:"s" == selected_term_id %}selected{% endif %}>
                                                        {{ term.name }} Term
                                                    </option>
                                                {% endif %}
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-search me-1"></i> Load
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Attendance Table -->
            {% if selected_session_id and selected_term_id %}
                <div class="card shadow">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Student Attendance Record</h5>
                        <span class="badge bg-light text-dark">
                            <i class="fas fa-calendar-alt me-1"></i> 
                            {{ selected_term_name|default:"Current Term" }}
                        </span>
                    </div>
                    <div class="card-body p-0">
                        <form method="POST" id="attendanceForm" action="{% url 'mark_attendance' %}">
                            {% csrf_token %}
                            <input type="hidden" id="sessionIdInput" name="session_id" value="{{ selected_session_id }}">
                            <input type="hidden" id="termIdInput" name="term_id" value="{{ selected_term_id }}">
                        
                            <div class="table-responsive">
                                <table class="table table-striped table-hover mb-0">
                                    <thead class="table-dark">
                                        <tr>
                                            <th scope="col" class="text-center">#</th>
                                            <th scope="col">Student Name</th>
                                            <th scope="col">Email</th>
                                            <th scope="col">Program</th>
                                            <th scope="col" class="text-center">Present</th>
                                            <th scope="col" class="text-center">Absent</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for student in students %}
                                        <tr>
                                            <td class="text-center">{{ forloop.counter }}</td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    {% if student.admin.profile_pic %}
                                                        <img src="{{ student.admin.profile_pic.url }}" alt="" class="rounded-circle me-2" width="32" height="32">
                                                    {% else %}
                                                        <div class="bg-secondary rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                                            <i class="fas fa-user text-white"></i>
                                                        </div>
                                                    {% endif %}
                                                    <span>{{ student.admin.first_name }} {{ student.admin.last_name }}</span>
                                                </div>
                                            </td>
                                            <td>{{ student.admin.email }}</td>
                                            <td>{{ student.program.name }}</td>
                                            <td class="text-center">
                                                <div class="form-check d-inline-block">
                                                    <input type="checkbox" 
                                                        class="form-check-input attendance-checkbox present-checkbox" 
                                                        id="present-{{ student.id }}"
                                                        data-student-id="{{ student.id }}"
                                                        data-session-id="{{ selected_session_id }}"
                                                        data-term-id="{{ selected_term_id }}"
                                                        data-status="present"
                                                        aria-label="Mark as present"
                                                        {% if student.attendance_record and student.attendance_record.is_present %}checked{% endif %}>
                                                    <label class="form-check-label visually-hidden" for="present-{{ student.id }}">Present</label>
                                                </div>
                                                <span class="badge bg-success attendance-count" id="present-count-{{ student.id }}">
                                                    {% if student.attendance_record and student.attendance_record.is_present %}1{% else %}0{% endif %}
                                                </span>
                                            </td>
                                            <td class="text-center">
                                                <div class="form-check d-inline-block">
                                                    <input type="checkbox" 
                                                        class="form-check-input attendance-checkbox absent-checkbox" 
                                                        id="absent-{{ student.id }}"
                                                        data-student-id="{{ student.id }}"
                                                        data-session-id="{{ selected_session_id }}"
                                                        data-term-id="{{ selected_term_id }}"
                                                        data-status="absent"
                                                        aria-label="Mark as absent"
                                                        {% if student.attendance_record and student.attendance_record.is_absent %}checked{% endif %}>
                                                    <label class="form-check-label visually-hidden" for="absent-{{ student.id }}">Absent</label>
                                                </div>
                                                <span class="badge bg-danger attendance-count" id="absent-count-{{ student.id }}">
                                                    {% if student.attendance_record and student.attendance_record.is_absent %}1{% else %}0{% endif %}
                                                </span>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="6" class="text-center py-4">
                                                <div class="alert alert-info mb-0">
                                                    <i class="fas fa-info-circle me-2"></i> No students found for the selected session and term.
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </form>
                    </div>
                    <div class="card-footer bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted"><small>Changes are saved automatically</small></span>
                            <button type="button" id="refreshBtn" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-sync-alt me-1"></i> Refresh Data
                            </button>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i> Please select both a session and term to view and mark attendance.
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="attendanceToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Attendance Update</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            Attendance updated successfully.
        </div>
    </div>
</div>
{% endblock content %}

{% block custom_js %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Session change handler - enable/disable term dropdown
        const sessionSelect = document.getElementById('session');
        const termSelect = document.getElementById('term');
        
        if (sessionSelect) {
            sessionSelect.addEventListener('change', function() {
                if (this.value) {
                    termSelect.disabled = false;
                } else {
                    termSelect.disabled = true;
                    termSelect.value = '';
                }
            });
        }
        
        // Refresh button handler
        const refreshBtn = document.getElementById('refreshBtn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', function() {
                window.location.reload();
            });
        }
        
        // Initialize toast
        let toastEl = document.getElementById('attendanceToast');
        let toast = new bootstrap.Toast(toastEl, {
            delay: 3000
        });
        
        // Attendance checkbox handlers
        document.querySelectorAll(".attendance-checkbox").forEach(checkbox => {
            checkbox.addEventListener("change", function () {
                let studentId = this.dataset.studentId;
                let sessionId = this.dataset.sessionId;
                let termId = this.dataset.termId;
                let status = this.dataset.status;
                let isChecked = this.checked;
                
                // Show loading state
                this.disabled = true;
                
                // Prevent both checkboxes from being checked at the same time
                if (status === "present" && isChecked) {
                    const absentCheckbox = document.querySelector(`.absent-checkbox[data-student-id="${studentId}"]`);
                    if (absentCheckbox) {
                        absentCheckbox.checked = false;
                        absentCheckbox.disabled = true;
                    }
                } else if (status === "absent" && isChecked) {
                    const presentCheckbox = document.querySelector(`.present-checkbox[data-student-id="${studentId}"]`);
                    if (presentCheckbox) {
                        presentCheckbox.checked = false;
                        presentCheckbox.disabled = true;
                    }
                }
    
                fetch("{% url 'mark_attendance' %}", {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: new URLSearchParams({
                        student_id: studentId,
                        session_id: sessionId,
                        term_id: termId,
                        status: status
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Update the present/absent count
                        const presentCount = document.getElementById(`present-count-${studentId}`);
                        const absentCount = document.getElementById(`absent-count-${studentId}`);
                        
                        if (presentCount) presentCount.innerText = data.present_count;
                        if (absentCount) absentCount.innerText = data.absent_count;
                        
                        // Show success toast
                        document.getElementById('toastMessage').innerHTML = `
                            <i class="fas fa-check-circle text-success me-2"></i>
                            Attendance updated successfully for ${data.student_name || 'student'}.
                        `;
                        toast.show();
                    } else {
                        throw new Error(data.message || 'Failed to update attendance');
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    
                    // Show error toast
                    document.getElementById('toastMessage').innerHTML = `
                        <i class="fas fa-exclamation-circle text-danger me-2"></i>
                        ${error.message || 'Failed to update attendance. Please try again.'}
                    `;
                    toast.show();
                    
                    // Revert checkbox state on error
                    this.checked = !isChecked;
                })
                .finally(() => {
                    // Re-enable checkboxes
                    document.querySelectorAll(`.attendance-checkbox[data-student-id="${studentId}"]`).forEach(cb => {
                        cb.disabled = false;
                    });
                });
            });
        });
    });
</script>
{% endblock custom_js %} {% endcomment %}

